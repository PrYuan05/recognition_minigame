<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<title>入~這個字在騙你ㄟ</title>

<style>
:root{
  --red:#ff4d4d;
  --blue:#4da6ff;
  --yellow:#ffe066;
  --green:#4dff88;
}

html, body {
  margin:0;
  touch-action: manipulation;
  -webkit-touch-callout: none;
  -webkit-user-select: none;
  user-select: none;
  font-family:"Noto Sans TC","Microsoft JhengHei",sans-serif;
  background:#05080f;
  color:white;
  overflow:hidden;
}

/* === 背景層 === */
#bg{position:fixed;inset:0;background:radial-gradient(circle at top,#0f1b3d,#05080f 70%);z-index:-3;}
#colorLayer{position:fixed;inset:0;background:#000;opacity:.65;transition:background .45s ease;z-index:-2;}
#scanlines{position:fixed;inset:0;background:repeating-linear-gradient(to bottom,rgba(255,255,255,.04) 0px,rgba(255,255,255,.04) 1px,transparent 2px,transparent 6px);pointer-events:none;z-index:-1;}

/* === 畫面容器 === */
.screen{
  display:none;
  height:100vh;
  padding: clamp(16px, 5vw, 120px);
  box-sizing:border-box;
  text-align:center;
}
.active{
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  animation:fade .4s ease;
}
@keyframes fade{from{opacity:0;transform:scale(.95)}to{opacity:1}}

/* === 文字尺寸（手機 → 電視） === */
#stage{
  font-size: clamp(20px, 3vw, 48px);
  letter-spacing:2px;
  text-shadow:0 0 12px cyan;
}
#rule{
  opacity:.85;
  margin-top:6px;
  font-size: clamp(16px, 2.5vw, 32px);
}
#countdown{
  font-size: clamp(64px, 10vw, 160px);
  margin:30px 0;
  animation:pulse 1s infinite;
}
@keyframes pulse{50%{text-shadow:0 0 30px cyan}}

.feedback{
  height:60px;
  font-size: clamp(22px, 4vw, 56px);
  margin-top:20px;
  text-shadow:0 0 16px #fff;
}

/* === Canvas：關鍵設定 === */
canvas{
  width: min(90vw, 70vh * 1.54);
  aspect-ratio: 400 / 260;
  height: auto;
}

/* === 按鈕 === */
.buttons{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap: clamp(12px, 3vw, 32px);
  width:100%;
  margin-top:auto;
}
button{
  height: clamp(72px, 12vh, 140px);
  font-size: clamp(22px, 4vw, 48px);
  border:none;
  border-radius:20px;
  color:white;
  font-weight:bold;
  letter-spacing:2px;
}
.red{background:linear-gradient(135deg,#ff3b3b,#a00000)}
.blue{background:linear-gradient(135deg,#3b8dff,#002a7a)}
.yellow{background:linear-gradient(135deg,#ffe066,#b89a00);color:#222}
.green{background:linear-gradient(135deg,#4dff88,#007a3d)}

.control{
  margin-top:22px;
  padding:16px 36px;
  font-size: clamp(18px, 3vw, 32px);
  border-radius:40px;
  border:none;
  background:linear-gradient(135deg,#00f5ff,#0066ff);
  color:#000;
  font-weight:bold;
  box-shadow:0 0 25px #00f5ff;
}
.control:disabled{opacity:.4;box-shadow:none}

/* === 錯題回顧 === */
#reviewList{max-height:400px;overflow-y:auto;width:100%;margin:20px 0;padding:10px}
.mistake-item{
  display:flex;
  align-items:center;
  justify-content:center;
  gap:20px;
  padding:15px;
  margin:10px 0;
  background:rgba(255,255,255,0.05);
  border-radius:10px;
  border-left:4px solid #ff4d4d;
}
.mistake-item .index{font-size:24px;font-weight:bold;color:#00f5ff}
.mistake-item .colors{display:flex;gap:10px;font-size:20px}
.correct-color{color:#4dff88}
.wrong-color{color:#ff4d4d;text-decoration:line-through}

#progressBar{
  display:flex;
  gap:8px;
  justify-content:center;
  margin:20px 0;
  min-height:50px;
  flex-wrap:wrap;
}
.progress-box{
  width:40px;height:40px;
  border-radius:8px;
  border:2px solid rgba(255,255,255,0.3);
  box-shadow:0 0 10px rgba(0,245,255,0.3);
  animation:popIn .3s ease;
}
@keyframes popIn{from{transform:scale(0)}to{transform:scale(1)}}
</style>
</head>

<body>
<div id="bg"></div><div id="colorLayer"></div><div id="scanlines"></div>

<div id="pauseScreen" class="screen active">
  <div id="stage"></div>
  <div id="rule"></div>
  <div id="countdown">3</div>
  <button id="startBtn" class="control" onclick="startSequence()">START ▶</button>
</div>

<div id="playScreen" class="screen">
  <canvas id="canvas"></canvas>
  <div id="feedback" class="feedback"></div>
</div>

<div id="answerScreen" class="screen">
  <div class="feedback">依序輸入節奏</div>
  <div id="progressBar"></div>
  <div class="buttons">
    <button class="red" onclick="press('紅')">紅</button>
    <button class="blue" onclick="press('藍')">藍</button>
    <button class="yellow" onclick="press('黃')">黃</button>
    <button class="green" onclick="press('綠')">綠</button>
  </div>
</div>

<div id="reviewScreen" class="screen">
  <div class="feedback">錯題回顧</div>
  <div id="reviewList"></div>
  <button class="control" onclick="continueGame()">繼續下一關 ▶</button>
</div>

<script>
/* ================= Canvas DPR 自適應 ================= */
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');

const MAX_DPR = 2;

function resizeCanvas(){
  const rect = canvas.getBoundingClientRect();
  const dpr = Math.min(window.devicePixelRatio || 1, MAX_DPR);

  canvas.width  = rect.width  * dpr;
  canvas.height = rect.height * dpr;

  ctx.setTransform(dpr,0,0,dpr,0,0);
}
window.addEventListener('resize', resizeCanvas);
resizeCanvas();

/* ================= 遊戲原邏輯（僅微調座標） ================= */

const colorLayer=document.getElementById('colorLayer');
const startBtn=document.getElementById('startBtn');

const COLORS={
  '紅':{c:'#ff4d4d',zy:'ㄏㄨㄥˊ'},
  '藍':{c:'#4da6ff',zy:'ㄌㄢˊ'},
  '黃':{c:'#ffe066',zy:'ㄏㄨㄤˊ'},
  '綠':{c:'#4dff88',zy:'ㄌㄩˋ'}
};

const STAGES=[
  {name:'簡單-1',count:5,speed:1200,mode:'bg',answerRule:'text'},
  {name:'簡單-2',count:6,speed:1200,mode:'bg',answerRule:'text'},
  {name:'中等-3',count:8,speed:1350,mode:'bg',answerRule:'text'},
  {name:'高級-4',count:6,speed:1000,mode:'text',answerRule:'word'},
  {name:'高級-5',count:6,speed:1200,mode:'text',answerRule:'word'},
  {name:'困難-6',count:7,speed:1300,mode:'text',answerRule:'text'}
];

let level=0,seq=[],colorSeq=[],idx=0,answer=[],mistakes=[];
let audioCtx=new (AudioContext||webkitAudioContext)();

function musicBeat(freq=440){
  const o=audioCtx.createOscillator();
  const g=audioCtx.createGain();
  o.frequency.value=freq;
  g.gain.setValueAtTime(0.15,audioCtx.currentTime);
  g.gain.exponentialRampToValueAtTime(0.001,audioCtx.currentTime+0.3);
  o.connect(g);g.connect(audioCtx.destination);
  o.start();o.stop(audioCtx.currentTime+0.3);
}

function drawChar(word, interference){
  const w = canvas.width / (window.devicePixelRatio||1);
  const h = canvas.height / (window.devicePixelRatio||1);

  ctx.clearRect(0,0,w,h);
  ctx.textAlign='center';
  ctx.textBaseline='middle';

  ctx.font = `bold ${Math.min(w,h)*0.45}px Microsoft JhengHei`;
  ctx.lineWidth=6;

  if(STAGES[level].mode==='text'){
    ctx.strokeStyle='black';
    ctx.strokeText(word,w/2,h/2);
    ctx.fillStyle=interference?COLORS[interference].c:'#fff';
  }else{
    ctx.fillStyle='#fff';
  }
  ctx.fillText(word,w/2,h/2);
}

function loadPause(){
  pauseScreen.classList.add('active');
  playScreen.classList.remove('active');
  answerScreen.classList.remove('active');
  stage.textContent=`關卡 ${level+1}｜${STAGES[level].name}`;
  rule.textContent=STAGES[level].answerRule==='word'?'看文字內容按':'看顏色按';
  startBtn.disabled=false;
  colorLayer.style.background='#000';
}

function startSequence(){
  let c=3;countdown.textContent=c;
  const t=setInterval(()=>{
    musicBeat(600);
    c--;countdown.textContent=c>0?c:'GO';
    if(c<0){clearInterval(t);generate();play();}
  },700);
}

function generate(){
  seq=[];colorSeq=[];
  const k=Object.keys(COLORS);
  for(let i=0;i<STAGES[level].count;i++){
    const w=k[Math.random()*4|0];
    seq.push(w);
    colorSeq.push(STAGES[level].mode==='text'
      ? k.filter(x=>x!==w)[Math.random()*3|0]
      : null);
  }
}

function play(){
  pauseScreen.classList.remove('active');
  playScreen.classList.add('active');
  idx=0;
  (function next(){
    if(idx>=seq.length){showAnswer();return;}
    const word=seq[idx];
    colorLayer.style.background=colorSeq[idx]?COLORS[colorSeq[idx]].c:COLORS[word].c;
    drawChar(word,colorSeq[idx]);
    musicBeat(420);
    idx++;
    setTimeout(next,STAGES[level].speed);
  })();
}

function showAnswer(){
  playScreen.classList.remove('active');
  answerScreen.classList.add('active');
  answer=[];
  progressBar.innerHTML='';
}

function press(c){
  answer.push(c);
  const b=document.createElement('div');
  b.className='progress-box';
  b.style.background=COLORS[c].c;
  progressBar.appendChild(b);
  if(answer.length===seq.length){
    let ok=0;mistakes=[];
    for(let i=0;i<seq.length;i++){
      const correct=STAGES[level].answerRule==='word'?seq[i]:colorSeq[i]||seq[i];
      if(answer[i]===correct) ok++;
      else mistakes.push({index:i+1,correct,wrong:answer[i]});
    }
    setTimeout(()=>mistakes.length?showReview():nextLevel(),1200);
  }
}

function showReview(){
  answerScreen.classList.remove('active');
  reviewScreen.classList.add('active');
  reviewList.innerHTML='';
  mistakes.forEach(m=>{
    reviewList.innerHTML+=`
      <div class="mistake-item">
        <span class="index">第 ${m.index} 題</span>
        <div class="colors">
          <span class="wrong-color">${m.wrong}</span> →
          <span class="correct-color">${m.correct}</span>
        </div>
      </div>`;
  });
}

function nextLevel(){
  reviewScreen.classList.remove('active');
  level=(level+1)%STAGES.length;
  loadPause();
}

loadPause();
</script>
</body>
</html>